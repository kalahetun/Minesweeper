# Service Discovery Makefile

.PHONY: build run test clean docker-build docker-run lint fmt help

# å˜é‡
BINARY_NAME=service-discovery
DOCKER_IMAGE=boifi/service-discovery
VERSION?=latest

# é»˜è®¤ç›®æ ‡
help:
	@echo "Service Discovery æ„å»ºå·¥å…·"
	@echo ""
	@echo "å¯ç”¨ç›®æ ‡:"
	@echo "  build         æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶"
	@echo "  run           è¿è¡ŒæœåŠ¡"
	@echo "  test          è¿è¡Œæµ‹è¯•"
	@echo "  test-unit     è¿è¡Œå•å…ƒæµ‹è¯•"
	@echo "  test-cover    è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š"
	@echo "  clean         æ¸…ç†æ„å»ºäº§ç‰©"
	@echo "  docker-build  æ„å»º Docker é•œåƒ"
	@echo "  docker-run    è¿è¡Œ Docker å®¹å™¨"
	@echo "  lint          è¿è¡Œä»£ç æ£€æŸ¥"
	@echo "  fmt           æ ¼å¼åŒ–ä»£ç "

# æ„å»º
build:
	@echo "ğŸ—ï¸ æ„å»º $(BINARY_NAME)..."
	CGO_ENABLED=0 go build -ldflags="-w -s" -o bin/$(BINARY_NAME) ./cmd
	@echo "âœ… æ„å»ºå®Œæˆ: bin/$(BINARY_NAME)"

# è¿è¡Œ
run: build
	@echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
	./bin/$(BINARY_NAME)

# å•æ¬¡è¿è¡Œ
run-once: build
	@echo "ğŸš€ å•æ¬¡è¿è¡Œ..."
	./bin/$(BINARY_NAME) --once

# æµ‹è¯•
test:
	@echo "ğŸ§ª è¿è¡Œæ‰€æœ‰æµ‹è¯•..."
	go test -v ./...

test-unit:
	@echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
	go test -v ./tests/unit/...

test-integration:
	@echo "ğŸ§ª è¿è¡Œé›†æˆæµ‹è¯•..."
	go test -v ./tests/integration/...

test-cover:
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡..."
	go test -coverprofile=coverage.out ./...
	go tool cover -html=coverage.out -o coverage.html
	@echo "âœ… è¦†ç›–ç‡æŠ¥å‘Š: coverage.html"

# æ¸…ç†
clean:
	@echo "ğŸ§¹ æ¸…ç†æ„å»ºäº§ç‰©..."
	rm -rf bin/
	rm -f coverage.out coverage.html
	@echo "âœ… æ¸…ç†å®Œæˆ"

# Docker
docker-build:
	@echo "ğŸ³ æ„å»º Docker é•œåƒ..."
	docker build -t $(DOCKER_IMAGE):$(VERSION) .
	@echo "âœ… é•œåƒæ„å»ºå®Œæˆ: $(DOCKER_IMAGE):$(VERSION)"

docker-run:
	@echo "ğŸ³ è¿è¡Œ Docker å®¹å™¨..."
	docker run --rm \
		-e BOIFI_JAEGER_URL=http://jaeger-query:16686 \
		-e BOIFI_REDIS_ADDR=redis:6379 \
		$(DOCKER_IMAGE):$(VERSION)

# ä»£ç è´¨é‡
lint:
	@echo "ğŸ” è¿è¡Œä»£ç æ£€æŸ¥..."
	golangci-lint run ./...

fmt:
	@echo "ğŸ“ æ ¼å¼åŒ–ä»£ç ..."
	go fmt ./...
	@echo "âœ… æ ¼å¼åŒ–å®Œæˆ"

# ä¾èµ–ç®¡ç†
deps:
	@echo "ğŸ“¦ ä¸‹è½½ä¾èµ–..."
	go mod download
	go mod tidy
	@echo "âœ… ä¾èµ–ä¸‹è½½å®Œæˆ"
