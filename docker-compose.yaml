services:
  # etcd Service
  # This service runs etcd as the persistent storage backend for the control plane.
  etcd:
    image: quay.io/coreos/etcd:v3.5.9
    ports:
      - "2379:2379"
    volumes:
      - etcd-data:/etcd-data
    command: >
      etcd --name etcd0
      --data-dir /etcd-data
      --listen-client-urls http://0.0.0.0:2379
      --advertise-client-urls http://etcd:2379
      --auto-compaction-mode periodic
      --auto-compaction-retention 1
    networks:
      - hfi-net
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health", "--endpoints=http://localhost:2379"]
      interval: 5s
      timeout: 2s
      retries: 5
      start_period: 10s

  # Control Plane Service
  # This service runs the Go application that serves policies to the Wasm plugin.
  control-plane:
    build:
      context: .
      dockerfile: Dockerfile.controlplane
    ports:
      - "8080:8080"
    environment:
      - STORAGE_BACKEND=etcd
      - ETCD_ENDPOINTS=http://etcd:2379
    networks:
      - hfi-net
    depends_on:
      etcd:
        condition: service_healthy
    # Use a healthcheck to ensure the control plane is ready before Envoy starts.
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/v1/health"]
      interval: 5s
      timeout: 2s
      retries: 5
      start_period: 30s

  # Wasm Plugin Builder Service (Rust)
  # This service builds the Rust Wasm plugin using the updated Dockerfile.wasm.
  # The compiled artifact is then copied to a volume for use by Envoy.
  wasm-builder:
    build:
      context: .
      dockerfile: Dockerfile.wasm
    # The output of this service is the compiled .wasm file in its container filesystem.
    # We define a volume to share this artifact with the Envoy service.
    volumes:
      - wasm-plugin:/opt/wasm-plugin
    command: ["sh", "-c", "cp /plugin.wasm /opt/wasm-plugin/plugin.wasm && echo 'Wasm plugin built successfully'"]

  # Envoy Proxy Service
  # This service runs the Envoy proxy, which loads the Wasm plugin.
  envoy:
    image: envoyproxy/envoy:v1.28.0
    ports:
      - "18000:18000" # External traffic
      - "19000:19000" # Admin interface
    volumes:
      # Mount the compiled .wasm file from the shared volume.
      - wasm-plugin:/etc/envoy/
      # Mount the Envoy configuration file.
      - ./envoy.yaml:/etc/envoy/envoy.yaml
    networks:
      - hfi-net
    # This is crucial. It ensures that the wasm-builder has finished and its
    # artifact is available before Envoy starts. It also waits for the control-plane
    # to be healthy.
    depends_on:
      wasm-builder:
        condition: service_completed_successfully
      control-plane:
        condition: service_healthy
    command: envoy -c /etc/envoy/envoy.yaml --log-level info

networks:
  hfi-net:
    driver: bridge

volumes:
  # This volume is used to pass the compiled .wasm file from the builder to Envoy.
  wasm-plugin:
    driver: local
  # This volume is used to persist etcd data.
  etcd-data:
    driver: local
