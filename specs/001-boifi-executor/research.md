# æµ‹è¯•è¦†ç›–ç‡åŸºå‡†æŠ¥å‘Š - Executor é¡¹ç›®

**ç”Ÿæˆæ—¥æœŸ**: 2025-11-14  
**é¡¹ç›®**: BOIFI Executor (Control Plane + CLI + Wasm Plugin)  
**ç›®çš„**: å»ºç«‹æµ‹è¯•è¦†ç›–ç‡åŸºå‡†ï¼Œè¯†åˆ«éœ€è¦æµ‹è¯•çš„åŒºåŸŸ

---

## ğŸ“Š æ‰§è¡Œæ‘˜è¦

| æŒ‡æ ‡ | å½“å‰çŠ¶æ€ | ç›®æ ‡ | å·®è· | ä¼˜å…ˆçº§ |
|------|--------|------|------|--------|
| Control Plane è¦†ç›–ç‡ | å¾…æµ‹é‡ | > 80% | TBD | ğŸ”´ é«˜ |
| CLI è¦†ç›–ç‡ | å¾…æµ‹é‡ | > 70% | TBD | ğŸŸ¡ ä¸­ |
| Wasm Plugin è¦†ç›–ç‡ | å¾…æµ‹é‡ | > 80% | TBD | ğŸ”´ é«˜ |
| å…¨å±€è¦†ç›–ç‡ | å¾…æµ‹é‡ | > 70% | TBD | ğŸ”´ é«˜ |

---

## ğŸ” å½“å‰æµ‹è¯•çŠ¶æ€åˆ†æ

### Control Plane (`executor/control-plane/`)

#### ç°æœ‰æµ‹è¯•æ–‡ä»¶
å·²è¯†åˆ«çš„ Test æ–‡ä»¶ï¼ˆå¾…è¿ç§»åˆ°æ–°ç»“æ„ï¼‰ï¼š
- `service/policy_service_test.go` - Policy CRUD æ“ä½œ
- `service/expiration_registry_test.go` - è‡ªåŠ¨è¿‡æœŸæœºåˆ¶
- `service/enhanced_service_test.go` - å¢å¼ºåŠŸèƒ½
- `service/policy_service_auto_expiration_test.go` - è‡ªåŠ¨è¿‡æœŸ
- `storage/enhanced_store_test.go` - å­˜å‚¨å¢å¼º
- `storage/watch_with_context_test.go` - Watch æœºåˆ¶
- `integration_test.go` - é›†æˆæµ‹è¯•

#### å·²è¦†ç›–çš„æ¨¡å—
```
âœ… Policy Service (CRUD)
âœ… Storage Backends (Memory & etcd)
âœ… Expiration Registry
âœ… Watch/Streaming
âŒ API Controllers (éœ€è¦è¦†ç›–)
âŒ Middleware (logging/errors)
âŒ Distributor (SSE åˆ†å‘)
âŒ Validator (éªŒè¯è§„åˆ™)
```

#### ä¼˜å…ˆçº§è¦†ç›–è®¡åˆ’

| ä¼˜å…ˆçº§ | æ¨¡å— | åŸå›  | é¢„æœŸå·¥ä½œé‡ |
|--------|------|------|----------|
| ğŸ”´ é«˜ | API Controllers | å¤–éƒ¨æ¥å£ï¼Œå½±å“æ‰€æœ‰å®¢æˆ·ç«¯ | ä¸­ |
| ğŸ”´ é«˜ | Distributor | SSE å…³é”®æµç¨‹ | ä¸­ |
| ğŸŸ¡ ä¸­ | Validator | æ•°æ®å®Œæ•´æ€§ | å° |
| ğŸŸ¡ ä¸­ | Middleware | æ—¥å¿—/é”™è¯¯å¤„ç† | å° |
| ğŸŸ¢ ä½ | Config | å¯åŠ¨é€»è¾‘ | å° |

#### æ¨èçš„æµ‹è¯•åœºæ™¯

**API Controller æµ‹è¯•** (æ–°å¢):
```go
// åœºæ™¯: POST /v1/policies
// - æœ‰æ•ˆ Policy åˆ›å»º
// - ç¼ºå°‘å¿…éœ€å­—æ®µæ—¶è¿”å› 400
// - æ— æ•ˆ JSON è¿”å› 400
// - å¹¶å‘è¯·æ±‚å¤„ç†

// åœºæ™¯: GET /v1/policies/{id}
// - å­˜åœ¨çš„ Policy è¿”å› 200
// - ä¸å­˜åœ¨çš„ Policy è¿”å› 404
// - æƒé™æ£€æŸ¥

// åœºæ™¯: DELETE /v1/policies/{id}
// - æˆåŠŸåˆ é™¤è¿”å› 204
// - ä¸å­˜åœ¨çš„ Policy è¿”å› 404
// - çº§è”åˆ é™¤éªŒè¯
```

**Distributor æµ‹è¯•** (æ–°å¢):
```go
// åœºæ™¯: å•ä¸ª SSE è¿æ¥
// - è¿æ¥å»ºç«‹
// - æ¥æ”¶æ›´æ–°
// - æ–­å¼€è¿æ¥æ¸…ç†

// åœºæ™¯: å¤šä¸ª SSE è¿æ¥
// - 10+ å¹¶å‘è¿æ¥
// - å¹¿æ’­åˆ°æ‰€æœ‰è¿æ¥
// - éƒ¨åˆ†è¿æ¥å¤±è´¥å¤„ç†

// åœºæ™¯: Policy æ›´æ–°å¹¿æ’­
// - Create â†’ æ‰€æœ‰å®¢æˆ·ç«¯æ¥æ”¶
// - Update â†’ æ‰€æœ‰å®¢æˆ·ç«¯æ¥æ”¶
// - Delete â†’ æ‰€æœ‰å®¢æˆ·ç«¯æ¥æ”¶
```

---

### CLI (`executor/cli/`)

#### ç°æœ‰æµ‹è¯•æ–‡ä»¶
- æ— ç°æœ‰æµ‹è¯•æ–‡ä»¶

#### å·²è¦†ç›–çš„æ¨¡å—
```
âŒ Policy Commands (apply/get/delete/list)
âŒ Client (HTTP communication)
âŒ Type Validation (YAML parsing)
âŒ Error Handling (invalid inputs)
```

#### ä¼˜å…ˆçº§è¦†ç›–è®¡åˆ’

| ä¼˜å…ˆçº§ | æ¨¡å— | åŸå›  | é¢„æœŸå·¥ä½œé‡ |
|--------|------|------|----------|
| ğŸ”´ é«˜ | Policy Commands | ç”¨æˆ·é¢æ¥å£ | ä¸­ |
| ğŸ”´ é«˜ | Client | API äº¤äº’ | ä¸­ |
| ğŸŸ¡ ä¸­ | Type Validation | æ•°æ®å®Œæ•´æ€§ | å° |
| ğŸŸ¡ ä¸­ | Error Handling | ç”¨æˆ·ä½“éªŒ | å° |

#### æ¨èçš„æµ‹è¯•åœºæ™¯

**Policy Command æµ‹è¯•** (æ–°å¢):
```bash
# åœºæ™¯: apply å‘½ä»¤
# - æœ‰æ•ˆ YAML æ–‡ä»¶
# - ç¼ºå°‘ YAML æ–‡ä»¶
# - æ— æ•ˆ YAML æ ¼å¼
# - è¿æ¥æ‹’ç»

# åœºæ™¯: get å‘½ä»¤
# - å­˜åœ¨çš„ Policy
# - ä¸å­˜åœ¨çš„ Policy
# - åˆ—è¡¨æ“ä½œ

# åœºæ™¯: delete å‘½ä»¤
# - æˆåŠŸåˆ é™¤
# - Policy ä¸å­˜åœ¨
# - æƒé™é”™è¯¯

# åœºæ™¯: list å‘½ä»¤
# - ç©ºåˆ—è¡¨
# - å¤šä¸ª Policy
# - ç­›é€‰å’Œæ’åº
```

**Client æµ‹è¯•** (æ–°å¢):
```go
// åœºæ™¯: HTTP è¿æ¥
// - æˆåŠŸè¯·æ±‚
// - è¶…æ—¶å¤„ç†
// - é‡è¯•é€»è¾‘
// - TLS è¯ä¹¦éªŒè¯

// åœºæ™¯: é”™è¯¯å¤„ç†
// - 4xx å“åº”
// - 5xx å“åº”
// - ç½‘ç»œé”™è¯¯
// - æ— æ•ˆå“åº”
```

---

### Wasm Plugin (`executor/wasm-plugin/`)

#### ç°æœ‰æµ‹è¯•æ–‡ä»¶
åˆ†æ•£åœ¨ `src/` ä¸­çš„æµ‹è¯•ï¼ˆå¾…è¿ç§»ï¼‰ï¼š
- `lib.rs` - é›†æˆæµ‹è¯•
- `matcher.rs` - åŒ¹é…å™¨å•å…ƒæµ‹è¯•
- `executor.rs` - æ‰§è¡Œå™¨å•å…ƒæµ‹è¯•
- `config.rs` - é…ç½®å•å…ƒæµ‹è¯•
- `reconnect.rs` - é‡è¿é€»è¾‘æµ‹è¯•
- `time_control.rs` - æ—¶é—´æ§åˆ¶æµ‹è¯•
- `panic_safety.rs` - ææ…Œå®‰å…¨æµ‹è¯•

#### å·²è¦†ç›–çš„æ¨¡å—
```
âœ… Matcher (æ­£åˆ™è¡¨è¾¾å¼ã€è·¯å¾„ã€header)
âœ… Executor (abort/delay)
âœ… Config (è§£æå’ŒéªŒè¯)
âœ… Time Control (å»¶è¿Ÿå’Œè¿‡æœŸ)
âœ… Panic Safety (ææ…Œæ¢å¤)
âœ… Reconnect (SSE è¿æ¥)
âŒ Metrics (æ€§èƒ½æŒ‡æ ‡)
âŒ Performance Baselines (æ€§èƒ½åŸºå‡†)
âŒ Concurrency Stress (å¹¶å‘å‹åŠ›)
```

#### ä¼˜å…ˆçº§è¦†ç›–è®¡åˆ’

| ä¼˜å…ˆçº§ | æ¨¡å— | åŸå›  | é¢„æœŸå·¥ä½œé‡ |
|--------|------|------|----------|
| ğŸ”´ é«˜ | Performance Baselines | å…³é”®çº¦æŸ | ä¸­ |
| ğŸŸ¡ ä¸­ | Concurrency Stress | ç¨³å®šæ€§ | ä¸­ |
| ğŸŸ¡ ä¸­ | Metrics | å¯è§‚æµ‹æ€§ | å° |
| ğŸŸ¢ ä½ | Edge Cases | é²æ£’æ€§ | å° |

#### æ¨èçš„æµ‹è¯•åœºæ™¯

**æ€§èƒ½åŸºå‡†** (æ–°å¢):
```rust
// åŸºå‡†: åŒ¹é…å™¨
// - å•è§„åˆ™åŒ¹é…: < 0.5ms
// - 10 è§„åˆ™åŒ¹é…: < 5ms
// - 100 è§„åˆ™åŒ¹é…: < 50ms

// åŸºå‡†: æ‰§è¡Œå™¨
// - Abort æ‰§è¡Œ: < 0.3ms
// - Delay æ‰§è¡Œ: < 1ms
// - æ— æ•…éšœæ‰§è¡Œ: < 0.1ms

// åŸºå‡†: å®Œæ•´æµç¨‹
// - è§£æ â†’ åŒ¹é… â†’ æ‰§è¡Œ: < 10ms
// - 1000 req/s ååé‡
```

**å¹¶å‘å‹åŠ›æµ‹è¯•** (æ–°å¢):
```rust
// åœºæ™¯: å¹¶å‘è§„åˆ™åº”ç”¨
// - 10 å¹¶å‘æ›´æ–° + 1000 req/s æµé‡
// - è§„åˆ™å˜åŒ–æ—¶æ— è¯·æ±‚ä¸¢å¤±
// - å†…å­˜æ³„æ¼æ£€æŸ¥

// åœºæ™¯: è¿æ¥æ¢å¤
// - ç½‘ç»œä¸­æ–­ + è‡ªåŠ¨é‡è¿
// - ç¼“å†²çš„æ›´æ–°æ¢å¤
// - æ²¡æœ‰é‡å¤åº”ç”¨

// åœºæ™¯: å¤šè§„åˆ™äº¤äº’
// - é¡ºåºä¾èµ–æ€§
// - åŒ¹é…ä¼˜å…ˆçº§
// - è§„åˆ™å†²çªå¤„ç†
```

---

## ğŸ“ˆ è¦†ç›–ç‡æµ‹é‡æ–¹æ³•

### ç”Ÿæˆåˆå§‹åŸºå‡†

#### Control Plane
```bash
cd executor/control-plane

# æµ‹é‡ç°æœ‰æµ‹è¯•çš„è¦†ç›–ç‡
go test -coverprofile=coverage.out ./...
go tool cover -html=coverage.out

# è®°å½•ç»“æœ
echo "Coverage Report:" > coverage-baseline.txt
go tool cover -func=coverage.out >> coverage-baseline.txt
```

#### CLI
```bash
cd executor/cli

# å»ºç«‹é›¶è¦†ç›–ç‡åŸºå‡†ï¼ˆç›®å‰æ— æµ‹è¯•ï¼‰
go test -coverprofile=coverage.out ./...
go tool cover -html=coverage.out
```

#### Wasm Plugin
```bash
cd executor/wasm-plugin

# æµ‹é‡ç°æœ‰æµ‹è¯•çš„è¦†ç›–ç‡
cargo tarpaulin --out Html --output-dir coverage
```

### è·Ÿè¸ªè¿›åº¦

ä¿å­˜åˆå§‹å’Œåç»­è¦†ç›–ç‡æŠ¥å‘Šï¼š
```
baseline-2025-11-14/
â”œâ”€â”€ cp-coverage.html
â”œâ”€â”€ cli-coverage.html
â””â”€â”€ wasm-coverage.html

checkpoint-2025-11-21/
â”œâ”€â”€ cp-coverage.html
â”œâ”€â”€ cli-coverage.html
â””â”€â”€ wasm-coverage.html
```

æ¯”è¾ƒï¼š
```bash
diff baseline-2025-11-14/cp-coverage.html checkpoint-2025-11-21/cp-coverage.html
```

---

## ğŸ¯ åˆ†é˜¶æ®µè¦†ç›–ç›®æ ‡

### Phase 1ï¼šè®¾ç½®ï¼ˆå½“å‰ï¼‰
**ç›®æ ‡**: å»ºç«‹åŸºç¡€è®¾æ–½å’ŒåŸºå‡†

- âœ… åˆ›å»ºæµ‹è¯•ç›®å½•ç»“æ„
- âœ… åˆ›å»º Makefile æ„å»ºç³»ç»Ÿ
- âœ… åˆ›å»º fixtures æ¨¡å—
- â³ **â†’ ç”Ÿæˆåˆå§‹è¦†ç›–ç‡æŠ¥å‘Šï¼ˆæœ¬æŠ¥å‘Šï¼‰**

**é¢„æœŸè¦†ç›–ç‡**: 
- Control Plane: 30-40%ï¼ˆç°æœ‰æµ‹è¯•ï¼‰
- CLI: 0%ï¼ˆæ— æµ‹è¯•ï¼‰
- Wasm Plugin: 50-60%ï¼ˆç°æœ‰æµ‹è¯•ï¼‰

### Phase 2ï¼šè¿ç§»ï¼ˆåç»­ï¼‰
**ç›®æ ‡**: å°†ç°æœ‰æµ‹è¯•è¿ç§»åˆ°æ–°ç»“æ„ï¼Œæé«˜è¦†ç›–ç‡

- T013-T030: è¿ç§»ç°æœ‰æµ‹è¯•æ–‡ä»¶
- æ·»åŠ ç¼ºå¤±çš„åœºæ™¯
- ä¿®å¤ä¸ç¨³å®šçš„æµ‹è¯•

**ç›®æ ‡è¦†ç›–ç‡**:
- Control Plane: 60%
- CLI: 50%
- Wasm Plugin: 70%

### Phase 3-5ï¼šç”¨æˆ·æ•…äº‹å®ç°
**ç›®æ ‡**: å®ç°åŠŸèƒ½åŒæ—¶æ·»åŠ æµ‹è¯•

- T031-T065: æ¯é¡¹åŠŸèƒ½éƒ½æœ‰æµ‹è¯•
- TDD é©±åŠ¨å¼€å‘

**ç›®æ ‡è¦†ç›–ç‡**:
- Control Plane: 80%+
- CLI: 70%+
- Wasm Plugin: 85%+

### Phase 6-8ï¼šå®Œæ•´å’Œä¼˜åŒ–
**ç›®æ ‡**: è¾¾åˆ°è¦†ç›–ç‡ç›®æ ‡ï¼Œæ€§èƒ½ä¼˜åŒ–

- T066-T103: å®Œæ•´è¦†ç›–å’Œä¼˜åŒ–
- æ€§èƒ½åŸºå‡†æµ‹è¯•
- ç«¯åˆ°ç«¯åœºæ™¯

**ç›®æ ‡è¦†ç›–ç‡**:
- å…¨å±€: > 80%
- æ ¸å¿ƒä¸šåŠ¡é€»è¾‘: > 90%

---

## ğŸ“‹ ç¼ºå¤±è¦†ç›–çš„æ¨¡å—æ¸…å•

### éœ€è¦ç«‹å³æµ‹è¯•çš„

| ç»„ä»¶ | æ¨¡å— | æµ‹è¯•ç±»å‹ | ä¼˜å…ˆçº§ | å¤æ‚åº¦ |
|------|------|---------|--------|--------|
| CP | API Controllers | å•å…ƒ + é›†æˆ | ğŸ”´ | ä¸­ |
| CP | Distributor | é›†æˆ + å¹¶å‘ | ğŸ”´ | ä¸­ |
| CLI | Policy Commands | å•å…ƒ + é›†æˆ | ğŸ”´ | ä¸­ |
| CLI | Client | å•å…ƒ + é›†æˆ | ğŸ”´ | ä¸­ |
| WP | Performance | æ€§èƒ½åŸºå‡† | ğŸ”´ | ä¸­ |
| WP | Concurrency | å‹åŠ›æµ‹è¯• | ğŸŸ¡ | ä¸­ |

### ä¸‹ä¸€é˜¶æ®µè¦†ç›–

| ç»„ä»¶ | æ¨¡å— | æµ‹è¯•ç±»å‹ | ä¼˜å…ˆçº§ | å¤æ‚åº¦ |
|------|------|---------|--------|--------|
| CP | Middleware | å•å…ƒ | ğŸŸ¡ | å° |
| CP | Validator | å•å…ƒ | ğŸŸ¡ | å° |
| CLI | Error Handling | å•å…ƒ | ğŸŸ¡ | å° |
| WP | Metrics | å•å…ƒ | ğŸŸ¡ | å° |

---

## ğŸš€ å¿«é€Ÿå¯åŠ¨å‘½ä»¤

### ç”Ÿæˆä½ çš„ç¬¬ä¸€ä¸ªè¦†ç›–ç‡æŠ¥å‘Š

```bash
# Control Plane
cd executor/control-plane
go test -coverprofile=coverage.out ./...
go tool cover -html=coverage.out
# åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ coverage.html

# CLI
cd executor/cli
go test -coverprofile=coverage.out ./...
go tool cover -html=coverage.out

# Wasm Plugin
cd executor/wasm-plugin
cargo tarpaulin --out Html --output-dir coverage
# åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ coverage/index.html
```

### æŒ‰æ–‡ä»¶æŸ¥çœ‹è¦†ç›–ç‡

```bash
# Go
go tool cover -func=coverage.out | grep -E "(total|\.go:)" | head -20

# æ˜¾ç¤ºä¸è¦†ç›–çš„å‡½æ•°
go tool cover -func=coverage.out | grep 0.0%
```

---

## ğŸ’¡ å…³é”®è§è§£å’Œå»ºè®®

### 1. ä¼˜å…ˆçº§æ’åº
- **ç«‹å³**: API Controllers å’Œ Distributorï¼ˆControl Plane çš„å¤–éƒ¨æ¥å£ï¼‰
- **æ¬¡è¦**: CLI å‘½ä»¤å’Œå®¢æˆ·ç«¯ï¼ˆç”¨æˆ·é¢æ¥å£ï¼‰
- **æ€§èƒ½**: Wasm Plugin åŸºå‡†æµ‹è¯•ï¼ˆå…³é”®çº¦æŸï¼‰

### 2. å¿«é€Ÿèµ¢åˆ©
- è¿ç§»ç°æœ‰çš„ 180+ ä¸ªæ•£å¸ƒçš„æµ‹è¯•ï¼ˆPhase 2ï¼‰
- é¢„æœŸå°†è¦†ç›–ç‡æé«˜ 20-30%

### 3. æµ‹è¯•ç­–ç•¥
- **Control Plane**: å…³æ³¨é›†æˆå’Œ API æµ‹è¯•
- **CLI**: å…³æ³¨å‘½ä»¤å’Œå®¢æˆ·ç«¯äº¤äº’
- **Wasm Plugin**: å…³æ³¨æ€§èƒ½åŸºå‡†

### 4. å¹¶å‘æ‰§è¡Œ
- ä¸‰ä¸ªç»„ä»¶çš„æµ‹è¯•ç¼–å†™å¯ä»¥å¹¶è¡Œè¿›è¡Œ
- æ¨è 3-4 ä¸ªå¼€å‘äººå‘˜åŒæ—¶å¤„ç†ä¸åŒç»„ä»¶

---

## ğŸ“ åç»­æ­¥éª¤

1. **ç”ŸæˆåŸºå‡†** (ç°åœ¨):
   ```bash
   make test-coverage
   ```

2. **åˆ†æç¼ºé™·** (ä»Šå¤©):
   - æŸ¥çœ‹ HTML è¦†ç›–ç‡æŠ¥å‘Š
   - æ ‡è®°çº¢è‰²åŒºåŸŸï¼ˆæ— è¦†ç›–ï¼‰

3. **ä¼˜å…ˆçº§æ’åº** (æœ¬å‘¨):
   - æŒ‰ç…§ä¸Šè¡¨ä¸­çš„ä¼˜å…ˆçº§å¯¹å·¥ä½œè¿›è¡Œæ’åº
   - åˆ†é…ä»»åŠ¡ç»™å›¢é˜Ÿæˆå‘˜

4. **æ‰§è¡Œ** (åç»­):
   - æŒ‰ç…§ Phase 2-8 çš„ä»»åŠ¡å®æ–½
   - å®šæœŸæ£€æŸ¥è¦†ç›–ç‡è¿›åº¦

---

## ğŸ“š å‚è€ƒèµ„æº

| èµ„æº | ä½ç½® |
|------|------|
| å®Œæ•´ä»»åŠ¡åˆ—è¡¨ | `/specs/001-boifi-executor/tasks.md` |
| æµ‹è¯•æ¶æ„æŒ‡å— | `/specs/001-boifi-executor/test-architecture.md` |
| å¿«é€Ÿå¯åŠ¨æŒ‡å— | `/specs/001-boifi-executor/quickstart.md` |
| é¡¹ç›®è®¾è®¡æ–‡æ¡£ | `/docs/design_doc/Design.md` |
| API å‚è€ƒ | `/docs/dev_doc/API_REFERENCE.md` |

---

**ç”Ÿæˆæ—¥æœŸ**: 2025-11-14  
**ä½œè€…**: é¡¹ç›®è§„åˆ’ç³»ç»Ÿ  
**ä¸‹ä¸€æ­¥**: æ‰§è¡Œ Phase 2 ä»»åŠ¡ï¼ˆæµ‹è¯•è¿ç§»ï¼‰
