openapi: 3.0.3
info:
  title: BOIFI Fault Injection Control Plane API
  description: |
    API for managing fault injection policies in Kubernetes/Istio deployments.
    
    **Key Changes for Multi-Pod Deployment**:
    - Added `selector` field to policies for service-level targeting
    - New `/health` and `/ready` endpoints for Kubernetes probes
  version: 2.0.0
  contact:
    name: BOIFI Team

servers:
  - url: http://control-plane.boifi.svc.cluster.local:8080
    description: In-cluster control plane service
  - url: http://localhost:8080
    description: Local development

tags:
  - name: policies
    description: Fault injection policy management
  - name: health
    description: Health and readiness probes

paths:
  /api/v1/policies:
    get:
      tags: [policies]
      summary: List all policies
      description: |
        Returns all policies. Wasm plugins call this endpoint to fetch policies
        and filter them locally based on their service identity.
      operationId: listPolicies
      responses:
        '200':
          description: List of policies
          content:
            application/json:
              schema:
                type: object
                properties:
                  policies:
                    type: array
                    items:
                      $ref: '#/components/schemas/FaultInjectionPolicy'
              example:
                policies:
                  - metadata:
                      name: "frontend-delay"
                    spec:
                      selector:
                        service: "frontend"
                        namespace: "demo"
                      rules:
                        - match:
                            path_prefix: "/api/"
                          fault:
                            delay_ms: 500
                            percentage: 50
    post:
      tags: [policies]
      summary: Create a new policy
      operationId: createPolicy
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FaultInjectionPolicy'
          application/x-yaml:
            schema:
              $ref: '#/components/schemas/FaultInjectionPolicy'
      responses:
        '201':
          description: Policy created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FaultInjectionPolicy'
        '400':
          description: Invalid policy format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Policy already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/policies/{name}:
    parameters:
      - name: name
        in: path
        required: true
        schema:
          type: string
        description: Policy name
    get:
      tags: [policies]
      summary: Get a specific policy
      operationId: getPolicy
      responses:
        '200':
          description: Policy details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FaultInjectionPolicy'
        '404':
          description: Policy not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    put:
      tags: [policies]
      summary: Update a policy
      operationId: updatePolicy
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FaultInjectionPolicy'
      responses:
        '200':
          description: Policy updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FaultInjectionPolicy'
        '404':
          description: Policy not found
    delete:
      tags: [policies]
      summary: Delete a policy
      operationId: deletePolicy
      responses:
        '204':
          description: Policy deleted
        '404':
          description: Policy not found

  /health:
    get:
      tags: [health]
      summary: Liveness probe
      description: Returns 200 if the service is alive
      operationId: healthCheck
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [healthy]
              example:
                status: "healthy"

  /ready:
    get:
      tags: [health]
      summary: Readiness probe
      description: Returns 200 if the service is ready to accept traffic
      operationId: readinessCheck
      responses:
        '200':
          description: Service is ready
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [ready]
                  etcd:
                    type: string
                    enum: [connected, disconnected]
              example:
                status: "ready"
                etcd: "connected"
        '503':
          description: Service not ready
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [not_ready]
                  etcd:
                    type: string

components:
  schemas:
    FaultInjectionPolicy:
      type: object
      required:
        - metadata
        - spec
      properties:
        metadata:
          $ref: '#/components/schemas/PolicyMetadata'
        spec:
          $ref: '#/components/schemas/PolicySpec'

    PolicyMetadata:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          description: Unique policy name
          pattern: '^[a-z0-9]([-a-z0-9]*[a-z0-9])?$'
          maxLength: 63
          example: "frontend-delay-policy"
        version:
          type: string
          description: Optional version string
          example: "v1"

    PolicySpec:
      type: object
      required:
        - rules
      properties:
        selector:
          $ref: '#/components/schemas/ServiceSelector'
        rules:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/FaultRule'

    ServiceSelector:
      type: object
      description: |
        Specifies which services this policy applies to.
        Omitting fields or using "*" means match all.
      properties:
        service:
          type: string
          default: "*"
          description: |
            Service/workload name to match. 
            Use "*" to match all services.
            Matched against Envoy's WORKLOAD_NAME metadata.
          example: "frontend"
        namespace:
          type: string
          default: "*"
          description: |
            Kubernetes namespace to match.
            Use "*" to match all namespaces.
            Matched against Envoy's NAMESPACE metadata.
          example: "demo"

    FaultRule:
      type: object
      required:
        - fault
      properties:
        match:
          $ref: '#/components/schemas/RuleMatch'
        fault:
          $ref: '#/components/schemas/FaultConfig'

    RuleMatch:
      type: object
      description: Conditions for when this rule applies
      properties:
        path_prefix:
          type: string
          description: Match requests with paths starting with this prefix
          example: "/api/"
        path_exact:
          type: string
          description: Match requests with exact path match
          example: "/api/health"
        headers:
          type: array
          items:
            $ref: '#/components/schemas/HeaderMatch'

    HeaderMatch:
      type: object
      required:
        - name
        - value
      properties:
        name:
          type: string
          description: Header name
          example: "x-fault-inject"
        value:
          type: string
          description: Header value to match
          example: "true"

    FaultConfig:
      type: object
      description: Fault injection configuration
      properties:
        abort_code:
          type: integer
          minimum: 200
          maximum: 599
          description: HTTP status code for abort injection
          example: 503
        delay_ms:
          type: integer
          minimum: 0
          description: Delay duration in milliseconds
          example: 500
        percentage:
          type: number
          minimum: 0
          maximum: 100
          description: Percentage of requests to inject fault
          example: 50
        start_delay_ms:
          type: integer
          minimum: 0
          description: Wait time before fault becomes active (per-request)
          example: 1000
        duration_seconds:
          type: integer
          minimum: 0
          description: Policy expiration time from first activation
          example: 3600

    Error:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          description: Error message
          example: "policy not found"
        code:
          type: string
          description: Error code
          example: "NOT_FOUND"
