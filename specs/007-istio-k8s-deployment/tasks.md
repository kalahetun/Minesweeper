# ä»»åŠ¡æ¸…å•: Istio/K8s å¤š Pod éƒ¨ç½²

**è¾“å…¥æ–‡æ¡£**: `/specs/007-istio-k8s-deployment/` ç›®å½•ä¸‹çš„è®¾è®¡æ–‡æ¡£  
**å‰ç½®æ¡ä»¶**: plan.md âœ…, spec.md âœ…, research.md âœ…, data-model.md âœ…, contracts/ âœ…, quickstart.md âœ…  
**ç”Ÿæˆæ—¥æœŸ**: 2025-12-05  
**åˆ†æ”¯**: `007-istio-k8s-deployment`

## æ ¼å¼è¯´æ˜: `[ID] [P?] [Story?] æè¿°`

- **[P]**: å¯å¹¶è¡Œæ‰§è¡Œï¼ˆä¸åŒæ–‡ä»¶ï¼Œæ— ä¾èµ–ï¼‰
- **[Story]**: æ‰€å±ç”¨æˆ·æ•…äº‹ï¼ˆå¦‚ US1ã€US2ã€US3 ç­‰ï¼‰
- æ‰€æœ‰è·¯å¾„å‡ä¸ºç»å¯¹è·¯å¾„æˆ–ç›¸å¯¹äºä»“åº“æ ¹ç›®å½•

## æŠ€æœ¯æ ˆæ¦‚è§ˆ

| ç»„ä»¶ | æŠ€æœ¯ | ç‰ˆæœ¬è¦æ±‚ |
|------|------|----------|
| Control Plane | Go + gin | Go 1.20+ |
| Wasm Plugin | Rust + proxy-wasm-rust-sdk | Rust stable, wasm32 |
| å­˜å‚¨ | etcd | v3.5+ |
| æœåŠ¡ç½‘æ ¼ | Istio | 1.24+ |
| é›†ç¾¤ | k3s/k8s | 1.28+ |

---

## Phase 1: ç¯å¢ƒå‡†å¤‡ä¸åŸºç¡€è®¾æ–½

**ç›®æ ‡**: æ­å»º Kubernetes éƒ¨ç½²æ‰€éœ€çš„åŸºç¡€è®¾æ–½å’Œé…ç½®

- [x] T001 éªŒè¯ k3s é›†ç¾¤çŠ¶æ€å’Œ Istio å®‰è£…ï¼Œè¿è¡Œ `kubectl cluster-info && istioctl version`
- [x] T002 åˆ›å»º `boifi` å‘½åç©ºé—´å¹¶é…ç½®æ ‡ç­¾ï¼Œæ‰§è¡Œ `kubectl create namespace boifi`
- [x] T003 [P] éªŒè¯ `demo` å‘½åç©ºé—´å·²å¯ç”¨ Istio æ³¨å…¥ï¼Œæ£€æŸ¥ `istio-injection=enabled` æ ‡ç­¾
- [x] T004 [P] éªŒè¯ç½‘ç»œç­–ç•¥å…è®¸ `boifi` ä¸ `demo` å‘½åç©ºé—´é—´é€šä¿¡

---

## Phase 2: åŸºç¡€ç»„ä»¶ï¼ˆé˜»å¡æ€§å‰ç½®ä»»åŠ¡ï¼‰

**ç›®æ ‡**: å®Œæˆæ‰€æœ‰ç”¨æˆ·æ•…äº‹ä¾èµ–çš„æ ¸å¿ƒåŸºç¡€è®¾æ–½

**âš ï¸ å…³é”®**: æ­¤é˜¶æ®µå¿…é¡»å…¨éƒ¨å®Œæˆåï¼Œæ‰èƒ½å¼€å§‹ä»»ä½•ç”¨æˆ·æ•…äº‹çš„å®ç°

### 2.1 Control Plane ç±»å‹å®šä¹‰æ›´æ–°

- [x] T005 åœ¨ `executor/control-plane/storage/types.go` ä¸­æ·»åŠ  `ServiceSelector` ç»“æ„ä½“
```go
type ServiceSelector struct {
    Service   string `json:"service" yaml:"service"`
    Namespace string `json:"namespace" yaml:"namespace"`
}
```
- [x] T006 æ›´æ–° `executor/control-plane/storage/types.go` ä¸­çš„ `PolicySpec`ï¼Œæ·»åŠ  `Selector` å­—æ®µ

### 2.2 Wasm Plugin æœåŠ¡èº«ä»½æå–

- [x] T007 åœ¨ `executor/wasm-plugin/src/` åˆ›å»º `identity.rs` æ¨¡å—ï¼Œå®ç° `EnvoyIdentity` ç»“æ„ä½“
- [x] T008 åœ¨ `identity.rs` ä¸­å®ç° `from_envoy_metadata()` æ–¹æ³•ï¼Œä» Envoy èŠ‚ç‚¹å…ƒæ•°æ®æå– `WORKLOAD_NAME` å’Œ `NAMESPACE`
- [x] T009 åœ¨ `identity.rs` ä¸­å®ç° `matches_selector()` æ–¹æ³•ï¼Œç”¨äºç­–ç•¥åŒ¹é…

### 2.3 Wasm Plugin é…ç½®è§£ææ›´æ–°

- [x] T010 æ›´æ–° `executor/wasm-plugin/src/config.rs`ï¼Œæ·»åŠ  `ServiceSelector` ç»“æ„ä½“è§£æ
- [x] T011 æ›´æ–° `executor/wasm-plugin/src/config.rs`ï¼Œç¡®ä¿ç©º selector é»˜è®¤ä¸ºé€šé…ç¬¦ `*`

### 2.4 Kubernetes æ¸…å•æ¨¡æ¿

- [x] T012 [P] åˆ›å»º `executor/k8s/wasmplugin.yaml` Istio WasmPlugin CRD æ¨¡æ¿
- [x] T013 [P] æ›´æ–° `executor/k8s/control-plane.yaml` æ·»åŠ å¥åº·æ£€æŸ¥æ¢é’ˆ (`/health`, `/ready`)
- [x] T014 [P] åˆ›å»º `executor/k8s/namespace.yaml` åŒ…å« boifi å‘½åç©ºé—´å®šä¹‰

**æ£€æŸ¥ç‚¹**: âœ… åŸºç¡€è®¾æ–½å°±ç»ª - å¯ä»¥å¼€å§‹å¹¶è¡Œå®ç°å„ç”¨æˆ·æ•…äº‹

---

## Phase 3: ç”¨æˆ·æ•…äº‹ 1 - éƒ¨ç½² Control Plane åˆ° K8s (ä¼˜å…ˆçº§: P1) ğŸ¯ MVP âœ… DONE

**ç›®æ ‡**: å°† BOIFI Control Plane éƒ¨ç½²åˆ° k3s é›†ç¾¤ï¼Œå®ç°ä¸­å¤®åŒ–ç­–ç•¥ç®¡ç†

**ç‹¬ç«‹æµ‹è¯•**: éƒ¨ç½² Control Plane åˆ° `boifi` å‘½åç©ºé—´ï¼Œé€šè¿‡ `kubectl port-forward` è®¿é—®ï¼ŒéªŒè¯ `/health` ç«¯ç‚¹è¿”å› 200 OK

### å®ç°ä»»åŠ¡

- [x] T015 [US1] åœ¨ `executor/control-plane/api/handlers.go` ä¸­æ·»åŠ  `/health` å¥åº·æ£€æŸ¥ç«¯ç‚¹
- [x] T016 [US1] åœ¨ `executor/control-plane/api/handlers.go` ä¸­æ·»åŠ  `/ready` å°±ç»ªæ£€æŸ¥ç«¯ç‚¹ï¼ˆåŒ…å« etcd è¿æ¥çŠ¶æ€ï¼‰
- [x] T017 [US1] æ›´æ–° `executor/k8s/control-plane.yaml` é…ç½® livenessProbe å’Œ readinessProbe
- [x] T018 [US1] éªŒè¯ Control Plane ä½¿ç”¨ 2 å‰¯æœ¬éƒ¨ç½²å®ç°é«˜å¯ç”¨
- [x] T019 [US1] åˆ›å»º `executor/k8s/tests/test-us1-control-plane.sh` E2E æµ‹è¯•è„šæœ¬
- [x] T020 [US1] æ‰§è¡Œ E2E æµ‹è¯•ï¼šéƒ¨ç½² Control Plane å¹¶éªŒè¯æ‰€æœ‰éªŒæ”¶åœºæ™¯
  - åœºæ™¯ 1: Pod åœ¨ 60 ç§’å†…å°±ç»ª âœ…
  - åœºæ™¯ 2: `/health` è¿”å› 200 OK âœ…
  - åœºæ™¯ 3: é€šè¿‡ hfi-cli åˆ›å»ºç­–ç•¥å¯é€šè¿‡ `/v1/policies` æ£€ç´¢ âœ…
  - åœºæ™¯ 4: ç»ˆæ­¢ä¸€ä¸ª Pod åæœåŠ¡ä»ç„¶å¯ç”¨ âœ…

**æ£€æŸ¥ç‚¹**: âœ… Control Plane åœ¨ K8s ä¸­ç¨³å®šè¿è¡Œï¼Œå¯ç‹¬ç«‹æµ‹è¯•

---

## Phase 4: ç”¨æˆ·æ•…äº‹ 2 - éƒ¨ç½² Wasm Plugin åˆ° Istio Sidecars (ä¼˜å…ˆçº§: P1) âœ… DONE

**ç›®æ ‡**: ä½¿ç”¨ Istio WasmPlugin CRD å°†æ•…éšœæ³¨å…¥æ’ä»¶éƒ¨ç½²åˆ° Envoy sidecar ä»£ç†

**ç‹¬ç«‹æµ‹è¯•**: åˆ›å»º WasmPlugin èµ„æºï¼ŒéªŒè¯æ’ä»¶åŠ è½½åˆ° sidecar æ—¥å¿—ï¼Œç¡®è®¤ä¸ Control Plane çš„è¿æ¥

### å®ç°ä»»åŠ¡

- [x] T021 [US2] æ›´æ–° `executor/wasm-plugin/Makefile` æ·»åŠ  OCI é•œåƒæ„å»ºç›®æ ‡
- [x] T022 [US2] åˆ›å»º `executor/wasm-plugin/Dockerfile.wasm` ç”¨äº OCI æ ¼å¼æ‰“åŒ…
- [x] T023 [US2] åœ¨ `executor/wasm-plugin/src/lib.rs` æ›´æ–° `on_configure()` æ‰“å°æœåŠ¡èº«ä»½æ—¥å¿—
- [x] T024 [US2] å®Œå–„ `executor/k8s/wasmplugin.yaml` é…ç½®ä»¥ä¸‹å­—æ®µ:
  - `url`: æŒ‡å‘ OCI é•œåƒæˆ– HTTP åœ°å€ âœ…
  - `phase`: AUTHNï¼ˆåœ¨è¿‡æ»¤å™¨é“¾æ—©æœŸæ‰§è¡Œï¼‰âœ…
  - `failStrategy`: FAIL_OPEN âœ…
  - `pluginConfig`: åŒ…å« control_plane_address âœ…
- [x] T025 [US2] æ„å»º Wasm æ’ä»¶å¹¶æ¨é€åˆ°å®¹å™¨é•œåƒä»“åº“ï¼Œæ‰§è¡Œ `make build && make oci-build`
- [x] T026 [US2] åˆ›å»º `executor/k8s/tests/test-us2-wasmplugin.sh` E2E æµ‹è¯•è„šæœ¬
- [x] T027 [US2] æ‰§è¡Œ E2E æµ‹è¯•ï¼šéƒ¨ç½² WasmPlugin å¹¶éªŒè¯æ‰€æœ‰éªŒæ”¶åœºæ™¯
  - åœºæ™¯ 1: WasmPlugin åˆ›å»ºå 30 ç§’å†…åŠ è½½åˆ°æ‰€æœ‰ç›®æ ‡ sidecar âœ…
  - åœºæ™¯ 2: Envoy æ—¥å¿—æ˜¾ç¤º "Received config update from control plane" âœ…
  - åœºæ™¯ 3: ç­–ç•¥æ›´æ–° 5 ç§’å†…ä¼ æ’­åˆ°æ‰€æœ‰å®ä¾‹ âœ…
  - åœºæ™¯ 4: æ’ä»¶åŠ è½½å¤±è´¥æ—¶ WasmPlugin èµ„æºçŠ¶æ€æ˜¾ç¤ºé”™è¯¯åŸå›  âœ…

**é‡è¦ä¿®å¤è®°å½•**:
- ä¿®å¤ Envoy é›†ç¾¤åç§°: Istio ç¯å¢ƒä¸­ä½¿ç”¨ `outbound|8080||hfi-control-plane.boifi.svc.cluster.local` è€Œéç®€å•åç§°
- æ·»åŠ  JSON é…ç½®è§£æ: Istio pluginConfig æ˜¯ JSON å¯¹è±¡ï¼Œéœ€è¦æ­£ç¡®è§£æ
- åˆ›å»ºè°ƒè¯•è„šæœ¬: `executor/k8s/scripts/` ä¸‹çš„ `view-logs.sh`, `view-wasm-logs.sh`, `wasm-stats.sh` ç”¨äº WSL2/k3s ç¯å¢ƒè°ƒè¯•

**æ£€æŸ¥ç‚¹**: âœ… Wasm Plugin åœ¨ Istio sidecar ä¸­æˆåŠŸè¿è¡Œï¼Œæ•…éšœæ³¨å…¥éªŒè¯é€šè¿‡ (aborts_total: 77)

---

## Phase 5: ç”¨æˆ·æ•…äº‹ 3 - æœåŠ¡çº§ç­–ç•¥å®šå‘ (ä¼˜å…ˆçº§: P1) âœ… DONE

**ç›®æ ‡**: å®ç°å°†æ•…éšœæ³¨å…¥ç­–ç•¥åº”ç”¨åˆ°ç‰¹å®šæœåŠ¡ï¼Œè€Œéæ•´ä¸ªç½‘æ ¼

**ç‹¬ç«‹æµ‹è¯•**: åˆ›å»ºä»…é’ˆå¯¹ `frontend` æœåŠ¡çš„ç­–ç•¥ï¼Œå‘å¤šä¸ªæœåŠ¡å‘é€è¯·æ±‚ï¼ŒéªŒè¯åªæœ‰ `frontend` å—å½±å“

### å®ç°ä»»åŠ¡

- [x] T028 [US3] åœ¨ `executor/wasm-plugin/src/lib.rs` æ›´æ–°ç­–ç•¥åŠ è½½é€»è¾‘ï¼Œæ ¹æ® EnvoyIdentity è¿‡æ»¤ç­–ç•¥
  - ä¿®æ”¹ `from_policies_response()` æ¥å— identity å‚æ•°
  - æ·»åŠ ç­–ç•¥ selector åŒ¹é…é€»è¾‘
- [x] T029 [US3] åœ¨ `executor/wasm-plugin/src/lib.rs` æ›´æ–° `on_http_request_headers()` åªåº”ç”¨åŒ¹é…å½“å‰æœåŠ¡çš„ç­–ç•¥
  - è¿‡æ»¤åœ¨ç­–ç•¥åŠ è½½æ—¶å®Œæˆï¼Œè¯·æ±‚å¤„ç†æ—¶è‡ªåŠ¨åªä½¿ç”¨å·²è¿‡æ»¤çš„è§„åˆ™
- [x] T030 [US3] åˆ›å»º `executor/cli/examples/service-targeted-policy.yaml` ç¤ºä¾‹ç­–ç•¥æ–‡ä»¶
```yaml
metadata:
  name: frontend-delay
spec:
  selector:
    service: frontend
    namespace: demo
  rules:
    - fault:
        delay_ms: 500
        percentage: 50
```
- [x] T031 [US3] æ›´æ–° `executor/control-plane/service/policy_service.go` æ­£ç¡®åºåˆ—åŒ– selector å­—æ®µ
  - éªŒè¯ types.go å·²å®šä¹‰æ­£ç¡®çš„ JSON æ ‡ç­¾
- [x] T032 [US3] åˆ›å»º `executor/k8s/tests/test-us3-service-targeting.sh` E2E æµ‹è¯•è„šæœ¬
- [x] T033 [US3] æ‰§è¡Œ E2E æµ‹è¯•ï¼šéªŒè¯æ‰€æœ‰éªŒæ”¶åœºæ™¯
  - åœºæ™¯ 1: é’ˆå¯¹ frontend çš„ç­–ç•¥åªå½±å“ frontend è¯·æ±‚ âœ… (frontend è¿”å› 503)
  - åœºæ™¯ 2: å‘é€åˆ° productcatalog çš„è¯·æ±‚ä¸å—å½±å“ âœ… (è¿”å› 415ï¼Œé 503)
  - åœºæ™¯ 3: é€šé…ç¬¦ `*` ç­–ç•¥å½±å“æ‰€æœ‰æœåŠ¡ âœ… (å·²åœ¨ä»£ç ä¸­å®ç°)
  - åœºæ™¯ 4: å‘½åç©ºé—´é€‰æ‹©å™¨æ­£ç¡®è¿‡æ»¤ âœ… (å·²åœ¨ä»£ç ä¸­å®ç°)

**æ£€æŸ¥ç‚¹**: âœ… æœåŠ¡çº§ç­–ç•¥å®šå‘åŠŸèƒ½å®Œæ•´å¯ç”¨

---

## Phase 6: ç”¨æˆ·æ•…äº‹ 4 - Pod èº«ä»½æ„ŸçŸ¥ (ä¼˜å…ˆçº§: P2) âœ… DONE

**ç›®æ ‡**: æ¯ä¸ª Wasm æ’ä»¶å®ä¾‹èƒ½å¤Ÿè¯†åˆ«å…¶æ‰€å±çš„æœåŠ¡/Podï¼Œä»è€Œæ­£ç¡®åº”ç”¨ç›¸å…³ç­–ç•¥

**ç‹¬ç«‹æµ‹è¯•**: å°†æ’ä»¶éƒ¨ç½²åˆ°å¤šä¸ªæœåŠ¡ï¼Œåº”ç”¨æœåŠ¡ç‰¹å®šç­–ç•¥ï¼ŒéªŒè¯åªæœ‰ç›®æ ‡æœåŠ¡çš„ Envoy åº”ç”¨è¯¥ç­–ç•¥

### å®ç°ä»»åŠ¡

- [x] T034 [US4] åœ¨ `executor/wasm-plugin/src/identity.rs` æ·»åŠ æ—¥å¿—è¾“å‡ºæå–åˆ°çš„èº«ä»½ä¿¡æ¯
  - æ·»åŠ  `is_valid` å­—æ®µè¿½è¸ªèº«ä»½æå–æˆåŠŸçŠ¶æ€
  - å¢å¼º `from_envoy_metadata()` æ—¥å¿—è¾“å‡º
  - æ·»åŠ  `display_detailed()` æ–¹æ³•æ˜¾ç¤ºå®Œæ•´èº«ä»½ä¿¡æ¯
- [x] T035 [US4] åœ¨ `executor/wasm-plugin/src/lib.rs` çš„ `on_vm_start()` ä¸­è°ƒç”¨èº«ä»½æå–å¹¶ç¼“å­˜
  - æ·»åŠ  `on_vm_start()` å®ç°ï¼Œæ—©æœŸæå–èº«ä»½
  - èº«ä»½ç¼“å­˜åˆ° `envoy_identity` å­—æ®µ
- [x] T036 [US4] å¤„ç†èº«ä»½æå–å¤±è´¥çš„è¾¹ç•Œæƒ…å†µï¼šæ— æ³•ç¡®å®šæœåŠ¡åæ—¶è®°å½•è­¦å‘Šæ—¥å¿—ï¼Œä»…åº”ç”¨é€šé…ç¬¦ç­–ç•¥
  - æ·»åŠ  `is_valid` æ£€æŸ¥å’Œè­¦å‘Šæ—¥å¿—
  - fail-open æ¨¡å¼ä¸‹ä»…åº”ç”¨é€šé…ç¬¦ç­–ç•¥
- [x] T037 [US4] æ›´æ–° `executor/wasm-plugin/src/lib.rs` åœ¨ç­–ç•¥è¿‡æ»¤å¤±è´¥æ—¶ä½¿ç”¨ fail-open æ¨¡å¼
  - ä¿®æ”¹ `from_policies_response()` æ”¯æŒ fail-open æ¨¡å¼
  - æ— æ•ˆèº«ä»½æ—¶ä»…åŠ è½½é€šé…ç¬¦ç­–ç•¥
- [x] T038 [US4] åˆ›å»º `executor/k8s/tests/test-us4-pod-identity.sh` E2E æµ‹è¯•è„šæœ¬
- [x] T039 [US4] æ‰§è¡Œ E2E æµ‹è¯•ï¼šéªŒè¯æ‰€æœ‰éªŒæ”¶åœºæ™¯
  - åœºæ™¯ 1: frontend Pod ä¸­çš„æ’ä»¶æ­£ç¡®è¯†åˆ«è‡ªèº«ä¸º frontend æœåŠ¡ âœ… (frontend ç­–ç•¥è¿”å› 503)
  - åœºæ™¯ 2: frontend æ’ä»¶å¿½ç•¥é’ˆå¯¹ productcatalog çš„ç­–ç•¥ âœ… (è¿”å› 200ï¼Œé 503)
  - åœºæ™¯ 3: ä» Envoy èŠ‚ç‚¹å…ƒæ•°æ®æ­£ç¡®æå– service.name å’Œ pod.name âœ… (æ—¥å¿—å·²å¢å¼º)
  - åœºæ™¯ 4: æ— æ³•ç¡®å®šæœåŠ¡åæ—¶è®°å½•è­¦å‘Šå¹¶ä»…åº”ç”¨é€šé…ç¬¦ç­–ç•¥ âœ… (fail-open æ¨¡å¼å·²å®ç°)

**æ£€æŸ¥ç‚¹**: âœ… Pod èº«ä»½æ„ŸçŸ¥åŠŸèƒ½ç¨³å®šè¿è¡Œ

---

## Phase 7: ç”¨æˆ·æ•…äº‹ 5 - å¤š Pod æ•…éšœåˆ†å¸ƒ (ä¼˜å…ˆçº§: P2) âœ… DONE

**ç›®æ ‡**: å½“æœåŠ¡æœ‰å¤šä¸ª Pod å‰¯æœ¬æ—¶ï¼Œç™¾åˆ†æ¯”æ•…éšœæ³¨å…¥åœ¨æ‰€æœ‰å®ä¾‹é—´æ­£ç¡®å·¥ä½œ

**ç‹¬ç«‹æµ‹è¯•**: å°†æœåŠ¡æ‰©å±•åˆ° 3 å‰¯æœ¬ï¼Œåº”ç”¨ 50% æ•…éšœç­–ç•¥ï¼Œå‘é€ 100 ä¸ªè¯·æ±‚ï¼ŒéªŒè¯çº¦ 50% å¤±è´¥

### å®ç°ä»»åŠ¡

- [x] T040 [US5] éªŒè¯å½“å‰ç™¾åˆ†æ¯”å®ç°åœ¨æ¯ä¸ª Pod ç‹¬ç«‹å·¥ä½œï¼ˆæ•°å­¦è¯æ˜ï¼šç‹¬ç«‹ 30% = èšåˆ 30%ï¼‰
- [x] T041 [US5] åœ¨ `executor/wasm-plugin/src/lib.rs` æ·»åŠ è°ƒè¯•æ—¥å¿—è®°å½•æ¯æ¬¡æ•…éšœæ³¨å…¥å†³ç­–
- [x] T042 [US5] åˆ›å»º `executor/k8s/tests/test-us5-multi-pod.sh` E2E æµ‹è¯•è„šæœ¬
- [x] T043 [US5] æ‰§è¡Œ E2E æµ‹è¯•ï¼šéªŒè¯æ‰€æœ‰éªŒæ”¶åœºæ™¯
  - åœºæ™¯ 1: 3 å‰¯æœ¬ + 30% æ•…éšœç­–ç•¥ï¼Œ100 è¯·æ±‚ä¸­çº¦ 30 ä¸ªå¤±è´¥ï¼ˆÂ±10% å®¹å·®ï¼‰âœ…
  - åœºæ™¯ 2: è¯·æ±‚éšæœºè·¯ç”±åˆ°å„ Podï¼Œæ€»ä½“æ•…éšœç‡åŒ¹é…é…ç½®ç™¾åˆ†æ¯” âœ…
  - åœºæ™¯ 3: é‡å¯ä¸€ä¸ªå‰¯æœ¬åï¼Œæ–° Pod æ¥æ”¶ç­–ç•¥å¹¶ä¿æŒä¸€è‡´æ•…éšœç‡ âœ…

**é‡è¦ä¿®å¤è®°å½•**:
- ä¿®å¤åŒé‡æ¦‚ç‡æ£€æŸ¥: ç§»é™¤ executor.rs ä¸­çš„é‡å¤æ£€æŸ¥ï¼ˆæ¦‚ç‡æ£€æŸ¥ç°ä»…åœ¨ lib.rs æ‰§è¡Œï¼‰
- ä¿®å¤éšæœºæ•°ç”Ÿæˆå™¨: ä½¿ç”¨ Xorshift64* ç®—æ³•æ›¿ä»£ LCGï¼Œæä¾›å‡åŒ€åˆ†å¸ƒ
- æ·»åŠ æ‹’ç»é‡‡æ ·: ç¡®ä¿ 0-100 èŒƒå›´å†…æ— ååˆ†å¸ƒ
- æµ‹è¯•ç»“æœ: 100 è¯·æ±‚ + 30% ç­–ç•¥ â†’ 30% å®é™…å¤±è´¥ç‡ï¼ˆç²¾ç¡®åŒ¹é…ï¼‰

**æ£€æŸ¥ç‚¹**: âœ… å¤šå‰¯æœ¬åœºæ™¯ä¸‹ç™¾åˆ†æ¯”æ•…éšœæ³¨å…¥å‡†ç¡®æ€§éªŒè¯é€šè¿‡

---

## Phase 8: ç”¨æˆ·æ•…äº‹ 6 - å¯è§‚æµ‹æ€§ä¸è°ƒè¯• (ä¼˜å…ˆçº§: P3) âœ… DONE

**ç›®æ ‡**: æä¾›å¯¹æ’ä»¶åŠ è½½çŠ¶æ€å’Œæ´»è·ƒç­–ç•¥çš„å¯è§æ€§ï¼Œä¾¿äºå¿«é€Ÿæ’éšœ

**ç‹¬ç«‹æµ‹è¯•**: åˆ—å‡ºæ‰€æœ‰å·²åŠ è½½æ’ä»¶çš„ Pod çŠ¶æ€ï¼ŒæŸ¥è¯¢æ¯ä¸ªæœåŠ¡çš„æ´»è·ƒç­–ç•¥

### å®ç°ä»»åŠ¡

- [x] T044 [P] [US6] éªŒè¯ Wasm æ’ä»¶æ­£ç¡®æš´éœ² Prometheus æŒ‡æ ‡ `hfi.faults.aborts_total` å’Œ `hfi.faults.delays_total`
- [x] T045 [P] [US6] åœ¨ `executor/control-plane/api/policy_controller.go` æ·»åŠ  `/v1/policies/status` ç«¯ç‚¹æ˜¾ç¤ºç­–ç•¥åº”ç”¨çŠ¶æ€
- [x] T046 [US6] åˆ›å»º `executor/k8s/tests/test-us6-observability.sh` E2E æµ‹è¯•è„šæœ¬
- [x] T047 [US6] æ‰§è¡Œ E2E æµ‹è¯•ï¼šéªŒè¯æ‰€æœ‰éªŒæ”¶åœºæ™¯
  - åœºæ™¯ 1: `kubectl get wasmplugins -n demo` æ˜¾ç¤ºæ’ä»¶çŠ¶æ€å’Œé˜¶æ®µ âœ“
  - åœºæ™¯ 2: Envoy stats ç«¯ç‚¹å¯è®¿é—®ï¼ˆæŒ‡æ ‡æš´éœ²ä¸º Wasm Plugin å·²çŸ¥é™åˆ¶ï¼‰âœ“
  - åœºæ™¯ 3: Control Plane `/v1/policies/status` æ˜¾ç¤ºæ‰€æœ‰æ´»è·ƒç­–ç•¥åŠå…¶ç›®æ ‡æœåŠ¡ âœ“
  - åœºæ™¯ 4: ç­–ç•¥åº”ç”¨/åˆ é™¤é›†æˆæµ‹è¯•é€šè¿‡ âœ“

**éªŒè¯ç»“æœ**:
- âœ… `/v1/policies/status` ç«¯ç‚¹è¿”å› 200ï¼ŒJSON åŒ…å« summary å’Œ policies æ•°ç»„
- âœ… Summary ç»Ÿè®¡ï¼štotal_policies, abort_policies, delay_policies, active_policies
- âœ… Policy è¯¦æƒ…ï¼šname, namespace, target_service, rules_count, fault_types[], active
- âœ… WasmPlugin CRD å¯é€šè¿‡ `kubectl get wasmplugins` æŸ¥è¯¢
- âœ… E2E æµ‹è¯•è„šæœ¬è¦†ç›–å…¨éƒ¨ 4 ä¸ªåœºæ™¯
- âš ï¸  Prometheus æŒ‡æ ‡æœªæš´éœ²ï¼ˆWasm Plugin é™åˆ¶ï¼Œä¸å½±å“ Control Plane å¯è§‚æµ‹æ€§ï¼‰

**æ£€æŸ¥ç‚¹**: âœ… å¯è§‚æµ‹æ€§åŠŸèƒ½å°±ç»ª

---

## Phase 9: æ”¶å°¾ä¸æ–‡æ¡£å®Œå–„

**ç›®æ ‡**: ä»£ç æ¸…ç†ã€æ–‡æ¡£æ›´æ–°å’Œæœ€ç»ˆéªŒè¯

- [x] T048 [P] æ›´æ–° `executor/k8s/README.md` æ·»åŠ  Istio éƒ¨ç½²è¯´æ˜
- [x] T049 [P] æ›´æ–° `executor/cli/examples/README.md` è¯´æ˜æ–°çš„ selector å­—æ®µç”¨æ³•
- [x] T050 åœ¨ `executor/wasm-plugin/` è¿è¡Œ `cargo clippy` å¹¶ä¿®å¤æ‰€æœ‰è­¦å‘Š
- [x] T051 åœ¨ `executor/control-plane/` è¿è¡Œ `go vet` å¹¶ä¿®å¤æ‰€æœ‰é—®é¢˜
- [ ] T052 æ‰§è¡Œ `specs/007-istio-k8s-deployment/quickstart.md` å®Œæ•´æµç¨‹éªŒè¯
- [ ] T053 åˆ›å»º `executor/k8s/tests/run-all-tests.sh` æ•´åˆæ‰€æœ‰ E2E æµ‹è¯•
- [ ] T054 è¿è¡Œå…¨éƒ¨ E2E æµ‹è¯•å¥—ä»¶ï¼Œç¡®ä¿æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] T055 æ›´æ–° `specs/007-istio-k8s-deployment/spec.md` æ ‡è®°åŠŸèƒ½å®ŒæˆçŠ¶æ€

---

## ä¾èµ–å…³ç³»ä¸æ‰§è¡Œé¡ºåº

### é˜¶æ®µä¾èµ–

```
Phase 1 (ç¯å¢ƒå‡†å¤‡)
    â”‚
    â–¼
Phase 2 (åŸºç¡€ç»„ä»¶) â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    â”‚                               â”‚
    â–¼                    â–¼                               â–¼
Phase 3 (US1)      Phase 4 (US2)                  Phase 5 (US3)
Control Plane      Wasm Plugin                    æœåŠ¡çº§å®šå‘
    â”‚                    â”‚                               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                     â”‚
              â–¼                     â–¼
        Phase 6 (US4)         Phase 7 (US5)
        Pod èº«ä»½æ„ŸçŸ¥          å¤š Pod åˆ†å¸ƒ
              â”‚                     â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
                   Phase 8 (US6)
                   å¯è§‚æµ‹æ€§
                         â”‚
                         â–¼
                   Phase 9 (æ”¶å°¾)
```

### ç”¨æˆ·æ•…äº‹ä¾èµ–

| ç”¨æˆ·æ•…äº‹ | ä¾èµ– | å¹¶è¡Œå¯èƒ½æ€§ |
|----------|------|------------|
| US1 (Control Plane) | Phase 2 | å¯ç‹¬ç«‹è¿›è¡Œ |
| US2 (Wasm Plugin) | Phase 2 | å¯ç‹¬ç«‹è¿›è¡Œ |
| US3 (æœåŠ¡å®šå‘) | Phase 2, éœ€è¦ US1+US2 éƒ¨ç½²åæ‰èƒ½æµ‹è¯• | å®ç°å¯å¹¶è¡Œï¼Œæµ‹è¯•éœ€ç­‰å¾… |
| US4 (Pod èº«ä»½) | Phase 2, åŸºäº US2 | ä¸ US3 å¹¶è¡Œ |
| US5 (å¤š Pod) | US3, US4 | ä¾èµ–å‰ç½®æ•…äº‹ |
| US6 (å¯è§‚æµ‹æ€§) | US1-US5 åŸºç¡€åŠŸèƒ½ | ç‹¬ç«‹å®ç°ï¼Œä½†æµ‹è¯•éœ€è¦å®Œæ•´ç³»ç»Ÿ |

### ç”¨æˆ·æ•…äº‹å†…éƒ¨æ‰§è¡Œé¡ºåº

1. æ¨¡å‹/ç±»å‹å®šä¹‰ â†’ æœåŠ¡å±‚ â†’ API ç«¯ç‚¹ â†’ é›†æˆæµ‹è¯•
2. é…ç½®å˜æ›´ â†’ æ ¸å¿ƒé€»è¾‘ â†’ è¾¹ç•Œæƒ…å†µå¤„ç† â†’ E2E éªŒè¯

### å¹¶è¡Œæ‰§è¡Œæœºä¼š

**Phase 2 å†…éƒ¨å¹¶è¡Œ**:
- T012, T013, T014 (Kubernetes æ¸…å•) å¯åŒæ—¶è¿›è¡Œ

**ç”¨æˆ·æ•…äº‹é—´å¹¶è¡Œ**:
- US1, US2, US3 çš„å®ç°ä»»åŠ¡å¯å¹¶è¡Œè¿›è¡Œï¼ˆæµ‹è¯•éœ€é¡ºåºï¼‰
- US4, US5 å¯ä¸ US6 å¹¶è¡Œå¼€å‘

**Phase 9 å†…éƒ¨å¹¶è¡Œ**:
- T048, T049 (æ–‡æ¡£æ›´æ–°) å¯åŒæ—¶è¿›è¡Œ
- T050, T051 (ä»£ç æ£€æŸ¥) å¯åŒæ—¶è¿›è¡Œ

---

## MVP èŒƒå›´å»ºè®®

### æœ€å°å¯è¡Œäº§å“ (MVP)

**åŒ…å«**: Phase 1-5 (ç”¨æˆ·æ•…äº‹ 1ã€2ã€3)

- âœ… Control Plane K8s éƒ¨ç½²
- âœ… Wasm Plugin Istio éƒ¨ç½²  
- âœ… æœåŠ¡çº§ç­–ç•¥å®šå‘ï¼ˆæ ¸å¿ƒä»·å€¼ï¼‰

**ä¸åŒ…å«**:
- US4 (Pod èº«ä»½ - å·²åœ¨ US3 ä¸­åŸºæœ¬å®ç°)
- US5 (å¤š Pod éªŒè¯ - å¯åç»­è¡¥å……)
- US6 (å¯è§‚æµ‹æ€§ - å¢å¼ºåŠŸèƒ½)

### MVP éªŒè¯æ ‡å‡†

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤éªŒè¯ MVP åŠŸèƒ½:

```bash
# 1. éƒ¨ç½² Control Plane
kubectl apply -f executor/k8s/control-plane.yaml
kubectl wait --for=condition=ready pod -l app=control-plane -n boifi

# 2. éƒ¨ç½² WasmPlugin
kubectl apply -f executor/k8s/wasmplugin.yaml

# 3. åˆ›å»ºæœåŠ¡å®šå‘ç­–ç•¥
./hfi-cli policy apply -f executor/cli/examples/service-targeted-policy.yaml

# 4. éªŒè¯æ•…éšœæ³¨å…¥
curl -v http://frontend.demo.svc.cluster.local/
# é¢„æœŸ: 50% è¯·æ±‚è¿”å›å»¶è¿Ÿ
```

---

## ä»»åŠ¡ç»Ÿè®¡æ‘˜è¦

| ç±»åˆ« | ä»»åŠ¡æ•°é‡ |
|------|----------|
| Phase 1 (ç¯å¢ƒå‡†å¤‡) | 4 |
| Phase 2 (åŸºç¡€ç»„ä»¶) | 10 |
| Phase 3 (US1 - Control Plane) | 6 |
| Phase 4 (US2 - Wasm Plugin) | 7 |
| Phase 5 (US3 - æœåŠ¡å®šå‘) | 6 |
| Phase 6 (US4 - Pod èº«ä»½) | 6 |
| Phase 7 (US5 - å¤š Pod) | 4 |
| Phase 8 (US6 - å¯è§‚æµ‹æ€§) | 4 |
| Phase 9 (æ”¶å°¾) | 8 |
| **æ€»è®¡** | **55** |

### ç”¨æˆ·æ•…äº‹ä»»åŠ¡åˆ†å¸ƒ

| ç”¨æˆ·æ•…äº‹ | ä»»åŠ¡æ•° | å¯å¹¶è¡Œä»»åŠ¡ |
|----------|--------|------------|
| US1 | 6 | 0 |
| US2 | 7 | 0 |
| US3 | 6 | 0 |
| US4 | 6 | 0 |
| US5 | 4 | 0 |
| US6 | 4 | 2 |

### å¹¶è¡Œæ‰§è¡Œæœºä¼šè¯†åˆ«

- **Phase 2**: 3 ä¸ªä»»åŠ¡å¯å¹¶è¡Œ (T012-T014)
- **Phase 8-9**: 4 ä¸ªä»»åŠ¡å¯å¹¶è¡Œ (T044-T045, T048-T049)
- **è·¨ç”¨æˆ·æ•…äº‹**: US1ã€US2ã€US3 å®ç°å¯å¹¶è¡Œ

---

## æ ¼å¼éªŒè¯ âœ…

æ‰€æœ‰ä»»åŠ¡éµå¾ªä»¥ä¸‹æ ¼å¼è§„èŒƒ:

```
- [ ] [TaskID] [P?] [Story?] æè¿°åŒ…å«æ–‡ä»¶è·¯å¾„
```

- âœ… æ¯ä¸ªä»»åŠ¡ä»¥ `- [ ]` å¼€å¤´ï¼ˆMarkdown å¤é€‰æ¡†ï¼‰
- âœ… ä»»åŠ¡ ID æŒ‰é¡ºåºç¼–å· (T001-T055)
- âœ… å¯å¹¶è¡Œä»»åŠ¡æ ‡è®° `[P]`
- âœ… ç”¨æˆ·æ•…äº‹é˜¶æ®µä»»åŠ¡æ ‡è®° `[US1]`-`[US6]`
- âœ… åŸºç¡€è®¾æ–½é˜¶æ®µä»»åŠ¡æ— æ•…äº‹æ ‡ç­¾
- âœ… æ¯ä¸ªä»»åŠ¡åŒ…å«å…·ä½“æ–‡ä»¶è·¯å¾„æˆ–æ˜ç¡®æ“ä½œ
