# HFI Makefile - ç»Ÿä¸€æ„å»ºè„šæœ¬

.PHONY: help build-all build-bin-control-plane build-bin-wasm-plugin build-bin-cli build-bin-clean build-docker build-k3s clean test test-go test-rust integration-test coverage verify setup fmt lint deps security run-local-docker stop-local-docker deploy-all deploy-namespace deploy-wasm-server deploy-control deploy-plugin deploy-envoyfilter undeploy redeploy status-k3s update-wasm-plugin logs-wasm-plugin logs-control test-k3s test-k8s-all

# é»˜è®¤ç›®æ ‡
help:
	@echo "BOIFI Fault Injection System - Makefile å¸®åŠ©"
	@echo ""
	@echo "ğŸ—ï¸  æ„å»ºç›®æ ‡:"
	@echo "  make build-all              - æ„å»ºæ‰€æœ‰ç»„ä»¶ (æ§åˆ¶å¹³é¢ + CLI + Wasmæ’ä»¶)"
	@echo "  make build-bin-control-plane  - æ„å»ºæ§åˆ¶å¹³é¢"
	@echo "  make build-bin-wasm-plugin    - æ„å»º Wasm æ’ä»¶"
	@echo "  make build-bin-cli            - æ„å»º CLI å·¥å…·"
	@echo "  make build-bin-clean          - æ¸…ç†æ„å»ºäº§ç‰©"
	@echo "  make build-docker             - æ„å»º Docker é•œåƒ"
	@echo "  make build-k3s                - æ„å»ºé•œåƒå¹¶å¯¼å…¥åˆ° k3s containerd"
	@echo ""
	@echo "ğŸ§ª æµ‹è¯•ç›®æ ‡:"
	@echo "  make test                   - è¿è¡Œæ‰€æœ‰æµ‹è¯• (Go + Rust)"
	@echo "  make test-go                - è¿è¡Œ Go æµ‹è¯•"
	@echo "  make test-rust              - è¿è¡Œ Rust æµ‹è¯•"
	@echo "  make integration-test       - è¿è¡Œé›†æˆæµ‹è¯•"
	@echo "  make coverage               - ç”Ÿæˆä»£ç è¦†ç›–ç‡"
	@echo "  make test-k3s               - è¿è¡Œ K8s ç«¯åˆ°ç«¯æµ‹è¯•"
	@echo "  make test-k8s-all           - è¿è¡Œæ‰€æœ‰ K8s æµ‹è¯•"
	@echo ""
	@echo "â˜¸ï¸  Kubernetes éƒ¨ç½²:"
	@echo "  make deploy-all         - å®Œæ•´ K8s éƒ¨ç½² (å‘½åç©ºé—´ + æ‰€æœ‰ç»„ä»¶)"
	@echo "  make deploy-namespace       - åˆ›å»ºå‘½åç©ºé—´"
	@echo "  make deploy-wasm-server     - éƒ¨ç½² Wasm æ’ä»¶æœåŠ¡å™¨"
	@echo "  make deploy-control     - éƒ¨ç½²æ§åˆ¶å¹³é¢"
	@echo "  make deploy-plugin      - éƒ¨ç½² WasmPlugin CRD"
	@echo "  make deploy-envoyfilter - éƒ¨ç½² EnvoyFilter"
	@echo "  make undeploy               - å¸è½½æ‰€æœ‰ K8s èµ„æº"
	@echo "  make redeploy               - å¿«é€Ÿé‡æ–°éƒ¨ç½² (å¸è½½ + éƒ¨ç½²)"
	@echo "  make status-k3s             - æ£€æŸ¥ K8s éƒ¨ç½²çŠ¶æ€"
	@echo "  make update-wasm-plugin     - æ›´æ–° Wasm æ’ä»¶å¹¶é‡å¯"
	@echo ""
	@echo "ğŸ“Š ç›‘æ§ä¸è°ƒè¯•:"
	@echo "  make logs-wasm-plugin       - æŸ¥çœ‹ Wasm æ’ä»¶æ—¥å¿—"
	@echo "  make logs-control       - æŸ¥çœ‹æ§åˆ¶å¹³é¢æ—¥å¿—"
	@echo ""
	@echo "ğŸ³ æœ¬åœ°å¼€å‘ç¯å¢ƒ:"
	@echo "  make run-local-docker       - æœ¬åœ° Docker ç¯å¢ƒå¯åŠ¨"
	@echo "  make stop-local-docker      - æœ¬åœ° Docker ç¯å¢ƒåœæ­¢"
	@echo ""
	@echo "ğŸ”§ å¼€å‘å·¥å…·:"
	@echo "  make verify                 - éªŒè¯ (æ„å»º+æµ‹è¯•)"
	@echo "  make setup                  - æ£€æŸ¥å¼€å‘ç¯å¢ƒä¾èµ–"
	@echo "  make fmt                    - ä»£ç æ ¼å¼åŒ–"
	@echo "  make lint                   - ä»£ç æ£€æŸ¥"
	@echo "  make deps                   - æ›´æ–°ä¾èµ–"
	@echo "  make security               - å®‰å…¨æ‰«æ"
	@echo "  make coverage               - æµ‹è¯•è¦†ç›–ç‡"
	@echo ""
	@echo "ğŸ“š å¸®åŠ©:"
	@echo "  make help                   - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
	@echo ""

# æ„å»ºæ‰€æœ‰ç»„ä»¶
build-all: build-bin-control-plane build-bin-wasm-plugin build-bin-cli
	@echo "âœ… æ‰€æœ‰ç»„ä»¶æ„å»ºå®Œæˆ"

# æ„å»ºæ§åˆ¶å¹³é¢
build-bin-control-plane:
	@echo "ğŸ—ï¸ æ„å»ºæ§åˆ¶å¹³é¢..."
	@cd control-plane && \
		CGO_ENABLED=0 go build -ldflags="-w -s" -o hfi-control-plane .
	@echo "âœ… æ§åˆ¶å¹³é¢æ„å»ºå®Œæˆ: control-plane/hfi-control-plane"

# æ„å»º WASM æ’ä»¶
build-bin-wasm-plugin:
	@echo "ğŸ—ï¸ æ„å»º WASM æ’ä»¶..."
	@cd wasm-plugin && \
		cargo build --target wasm32-unknown-unknown --release
	@cp wasm-plugin/target/wasm32-unknown-unknown/release/hfi_wasm_plugin.wasm plugin.wasm
	@echo "âœ… WASM æ’ä»¶æ„å»ºå®Œæˆ: plugin.wasm"

# æ„å»º CLI å·¥å…·
build-bin-cli:
	@echo "ğŸ—ï¸ æ„å»º CLI å·¥å…·..."
	@cd cli && \
		CGO_ENABLED=0 go build -ldflags="-w -s" -o hfi-cli .
	@echo "âœ… CLI å·¥å…·æ„å»ºå®Œæˆ: cli/hfi-cli"

# æ¸…ç†æ„å»ºäº§ç‰©
build-bin-clean:
	@echo "ğŸ§¹ æ¸…ç†æ„å»ºäº§ç‰©..."
	@rm -f control-plane/hfi-control-plane
	@rm -f cli/hfi-cli cli/hfi-cli-*
	@rm -f plugin.wasm
	@cd wasm-plugin && cargo clean
	@cd control-plane && go clean
	@cd cli && go clean
	@echo "âœ… æ¸…ç†å®Œæˆ"

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
test: test-go test-rust
	@echo "âœ… æ‰€æœ‰æµ‹è¯•å®Œæˆ"

# è¿è¡Œ Go æµ‹è¯•
test-go:
	@echo "ğŸ§ª è¿è¡Œ Go æµ‹è¯•..."
	@cd control-plane && go test -v ./...
	@cd cli && go test -v ./...
	@echo "âœ… Go æµ‹è¯•å®Œæˆ"

# è¿è¡Œ Rust æµ‹è¯•
test-rust:
	@echo "ğŸ§ª è¿è¡Œ Rust æµ‹è¯•..."
	@cd wasm-plugin && cargo test
	@echo "âœ… Rust æµ‹è¯•å®Œæˆ"

# ä»£ç è¦†ç›–ç‡
coverage:
	@echo "ğŸ“Š ç”Ÿæˆä»£ç è¦†ç›–ç‡æŠ¥å‘Š..."
	@cd control-plane && \
		go test -coverprofile=coverage.out ./... && \
		go tool cover -html=coverage.out -o coverage.html
	@cd cli && \
		go test -coverprofile=coverage.out ./... && \
		go tool cover -html=coverage.out -o coverage.html
	@echo "âœ… è¦†ç›–ç‡æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

# å¯åŠ¨æœ¬åœ°å¼€å‘ç¯å¢ƒ
run-local-docker:
	@echo "ğŸš€ å¯åŠ¨æœ¬åœ°å¼€å‘ç¯å¢ƒ..."
	@cd docker && docker-compose up -d
	@echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
	@echo ""
	@echo "æœåŠ¡åœ°å€:"
	@echo "  æ§åˆ¶å¹³é¢: http://localhost:8080"
	@echo "  Envoy ä»£ç†: http://localhost:18000"
	@echo "  Envoy ç®¡ç†: http://localhost:19000"
	@echo ""
	@echo "ä½¿ç”¨ 'make stop-local-docker' åœæ­¢ç¯å¢ƒ"

# åœæ­¢æœ¬åœ°å¼€å‘ç¯å¢ƒ
stop-local-docker:
	@echo "ğŸ›‘ åœæ­¢æœ¬åœ°å¼€å‘ç¯å¢ƒ..."
	@cd docker && docker-compose down -v
	@echo "âœ… æœ¬åœ°ç¯å¢ƒå·²åœæ­¢"

# éªŒè¯æ„å»ºå’Œæµ‹è¯•
verify: build-bin-clean build-all test
	@echo "ğŸ‰ éªŒè¯å®Œæˆ - æ‰€æœ‰ç»„ä»¶æ„å»ºæˆåŠŸï¼Œæµ‹è¯•é€šè¿‡"

# å®‰è£…å¼€å‘ä¾èµ–
setup:
	@echo "ğŸ”§ å®‰è£…å¼€å‘ä¾èµ–..."
	@echo "æ£€æŸ¥ Go ç¯å¢ƒ..."
	@go version || (echo "âŒ Go æœªå®‰è£…" && exit 1)
	@echo "æ£€æŸ¥ Rust ç¯å¢ƒ..."
	@rustc --version || (echo "âŒ Rust æœªå®‰è£…" && exit 1)
	@echo "æ£€æŸ¥ WASM ç›®æ ‡..."
	@rustup target list --installed | grep wasm32-unknown-unknown || rustup target add wasm32-unknown-unknown
	@echo "æ£€æŸ¥ Docker ç¯å¢ƒ..."
	@docker --version || (echo "âŒ Docker æœªå®‰è£…" && exit 1)
	@echo "âœ… å¼€å‘ç¯å¢ƒæ£€æŸ¥å®Œæˆ"

# ä»£ç æ ¼å¼åŒ–
fmt:
	@echo "ğŸ¨ æ ¼å¼åŒ–ä»£ç ..."
	@cd control-plane && go fmt ./...
	@cd cli && go fmt ./...
	@cd wasm-plugin && cargo fmt
	@echo "âœ… ä»£ç æ ¼å¼åŒ–å®Œæˆ"

# ä»£ç æ£€æŸ¥
lint:
	@echo "ğŸ” ä»£ç æ£€æŸ¥..."
	@cd control-plane && go vet ./...
	@cd cli && go vet ./...
	@cd wasm-plugin && cargo clippy -- -D warnings
	@echo "âœ… ä»£ç æ£€æŸ¥å®Œæˆ"

# æ›´æ–°ä¾èµ–
deps:
	@echo "ğŸ“¦ æ›´æ–°ä¾èµ–..."
	@cd control-plane && go mod tidy
	@cd cli && go mod tidy
	@cd wasm-plugin && cargo update
	@echo "âœ… ä¾èµ–æ›´æ–°å®Œæˆ"

# å®‰å…¨æ‰«æ
security:
	@echo "ğŸ”’ å®‰å…¨æ‰«æ..."
	@cd control-plane && go list -json -m all | nancy sleuth
	@cd cli && go list -json -m all | nancy sleuth
	@cd wasm-plugin && cargo audit
	@echo "âœ… å®‰å…¨æ‰«æå®Œæˆ"

# Docker é•œåƒæ„å»º
build-docker:
	@echo "ğŸ³ æ„å»º Docker é•œåƒ..."
	@docker build -f docker/Dockerfile.controlplane -t boifi/control-plane:latest .
	@docker build -f docker/Dockerfile.wasm -t boifi/wasm-plugin:latest .
	@echo "âœ… Docker é•œåƒæ„å»ºå®Œæˆ"

# æ„å»ºå¹¶å¯¼å…¥æ§åˆ¶å¹³é¢é•œåƒåˆ° k3s containerd
build-k3s: build-docker
	@echo "ğŸš€ å¯¼å…¥æ§åˆ¶å¹³é¢é•œåƒåˆ° k3s containerd..."
	@which sudo > /dev/null || (echo "âŒ sudo ä¸å¯ç”¨"; exit 1)
	@which ctr > /dev/null || (echo "âŒ ctr ä¸å¯ç”¨"; exit 1)
	@docker save boifi/control-plane:latest | sudo ctr -a /run/k3s/containerd/containerd.sock -n k8s.io images import -

# é›†æˆæµ‹è¯•
integration-test: run-local-docker
	@echo "ğŸ”¬ è¿è¡Œé›†æˆæµ‹è¯•..."
	@sleep 5  # ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨
	@cd control-plane && go test -tags=integration ./integration_test.go
	@make stop-local-docker
	@echo "âœ… é›†æˆæµ‹è¯•å®Œæˆ"

#==============================================================================
# Kubernetes éƒ¨ç½²ç›®æ ‡
#==============================================================================

# éƒ¨ç½²åˆ° Kubernetes - å®Œæ•´æµç¨‹
deploy-all: build-k3s deploy-namespace deploy-wasm-server deploy-control deploy-plugin deploy-envoyfilter
	@echo "âœ… K8s å®Œæ•´éƒ¨ç½²å®Œæˆ"
	@echo ""
	@echo "ğŸ“Š éƒ¨ç½²çŠ¶æ€:"
	@make status-k3s

# åˆ›å»ºå‘½åç©ºé—´
deploy-namespace:
	@echo "ğŸ”§ åˆ›å»º K8s å‘½åç©ºé—´..."
	@kubectl apply -f k8s/namespace.yaml
	@echo "âœ… å‘½åç©ºé—´åˆ›å»ºå®Œæˆ"

# éƒ¨ç½² Wasm æ’ä»¶æœåŠ¡å™¨
deploy-wasm-server: build-bin-wasm-plugin
	@echo "ğŸ“¦ éƒ¨ç½² Wasm æ’ä»¶æœåŠ¡å™¨..."
	@echo "  1. å¤åˆ¶ Wasm æ’ä»¶åˆ°ä¸»æœºè·¯å¾„..."
	@sudo mkdir -p /tmp/wasm-plugin
	@sudo cp wasm-plugin/target/wasm32-unknown-unknown/release/hfi_wasm_plugin.wasm /tmp/wasm-plugin/plugin.wasm
	@sudo chmod 644 /tmp/wasm-plugin/plugin.wasm
	@echo "  2. éƒ¨ç½² wasm-server..."
	@kubectl apply -f k8s/wasm-server.yaml
	@echo "  3. ç­‰å¾… wasm-server å°±ç»ª..."
	@kubectl wait --for=condition=ready pod -l app=wasm-server -n boifi --timeout=120s || true
	@echo "âœ… Wasm æ’ä»¶æœåŠ¡å™¨éƒ¨ç½²å®Œæˆ"

# éƒ¨ç½²æ§åˆ¶å¹³é¢
deploy-control:
	@echo "ğŸ›ï¸  éƒ¨ç½²æ§åˆ¶å¹³é¢..."
	@kubectl apply -f k8s/control-plane.yaml
	@echo "  ç­‰å¾…æ§åˆ¶å¹³é¢å°±ç»ª..."
	@kubectl wait --for=condition=ready pod -l app=control-plane -n boifi --timeout=120s || true
	@echo "âœ… æ§åˆ¶å¹³é¢éƒ¨ç½²å®Œæˆ"

# éƒ¨ç½² WasmPlugin CRD
deploy-plugin:
	@echo "ğŸ”Œ éƒ¨ç½² WasmPlugin CRD..."
	@kubectl apply -f k8s/wasmplugin.yaml
	@echo "  ç­‰å¾… WasmPlugin ç”Ÿæ•ˆ (5ç§’)..."
	@sleep 5
	@echo "âœ… WasmPlugin éƒ¨ç½²å®Œæˆ"

# éƒ¨ç½² EnvoyFilter (å¯é€‰)
deploy-envoyfilter:
	@echo "ğŸ”§ éƒ¨ç½² EnvoyFilter (ç»Ÿè®¡åŒ¹é…å™¨)..."
	@kubectl apply -f k8s/envoyfilter-wasm-stats.yaml
	@echo "âœ… EnvoyFilter éƒ¨ç½²å®Œæˆ"

# å¸è½½æ‰€æœ‰ K8s èµ„æº
undeploy:
	@echo "ğŸ—‘ï¸  å¸è½½ K8s èµ„æº..."
	@kubectl delete -f k8s/envoyfilter-wasm-stats.yaml --ignore-not-found=true
	@kubectl delete -f k8s/wasmplugin.yaml --ignore-not-found=true
	@kubectl delete -f k8s/control-plane.yaml --ignore-not-found=true
	@kubectl delete -f k8s/wasm-server.yaml --ignore-not-found=true
	@kubectl delete -f k8s/namespace.yaml --ignore-not-found=true
	@echo "âœ… K8s èµ„æºå¸è½½å®Œæˆ"

# æ£€æŸ¥ K8s éƒ¨ç½²çŠ¶æ€
status-k3s:
	@echo "ğŸ“Š æ£€æŸ¥ K8s éƒ¨ç½²çŠ¶æ€..."
	@echo ""
	@echo "=== Namespaces ==="
	@kubectl get ns boifi demo 2>/dev/null || echo "  âš ï¸  å‘½åç©ºé—´ä¸å­˜åœ¨"
	@echo ""
	@echo "=== Pods in boifi namespace ==="
	@kubectl get pods -n boifi 2>/dev/null || echo "  âš ï¸  æ—  pods"
	@echo ""
	@echo "=== Services in boifi namespace ==="
	@kubectl get svc -n boifi 2>/dev/null || echo "  âš ï¸  æ—  services"
	@echo ""
	@echo "=== WasmPlugin ==="
	@kubectl get wasmplugin -A 2>/dev/null || echo "  âš ï¸  WasmPlugin CRD æœªå®‰è£…æˆ–æ— å®ä¾‹"
	@echo ""
	@echo "=== EnvoyFilter ==="
	@kubectl get envoyfilter -A 2>/dev/null || echo "  âš ï¸  æ—  EnvoyFilter"
	@echo ""

# æ›´æ–° Wasm æ’ä»¶ (é‡æ–°ç¼–è¯‘å¹¶æ›´æ–°)
update-wasm-plugin: build-bin-wasm-plugin
	@echo "ğŸ”„ æ›´æ–° Wasm æ’ä»¶..."
	@echo "  1. å¤åˆ¶æ–°ç‰ˆæœ¬æ’ä»¶åˆ°ä¸»æœºè·¯å¾„..."
	@sudo cp wasm-plugin/target/wasm32-unknown-unknown/release/hfi_wasm_plugin.wasm /tmp/wasm-plugin/plugin.wasm
	@sudo chmod 644 /tmp/wasm-plugin/plugin.wasm
	@echo "  2. é‡å¯ wasm-server ä½¿å…¶ç”Ÿæ•ˆ..."
	@kubectl rollout restart deployment/wasm-server -n boifi
	@kubectl wait --for=condition=ready pod -l app=wasm-server -n boifi --timeout=120s || true
	@echo "  3. è§¦å‘ Istio sidecar é‡æ–°åŠ è½½æ’ä»¶..."
	@kubectl get pods -n demo -l app --no-headers | awk '{print $$1}' | xargs -I {} kubectl exec {} -n demo -c istio-proxy -- curl -X POST http://localhost:15000/reset_counters 2>/dev/null || true
	@echo "âœ… Wasm æ’ä»¶æ›´æ–°å®Œæˆ"

# æŸ¥çœ‹ Wasm æ’ä»¶æ—¥å¿—
logs-wasm-plugin:
	@echo "ğŸ“ æŸ¥çœ‹ Wasm æ’ä»¶æ—¥å¿— (ä» demo namespace çš„ç¬¬ä¸€ä¸ª pod)..."
	@POD=$$(kubectl get pods -n demo -l app --no-headers | head -1 | awk '{print $$1}'); \
	if [ -n "$$POD" ]; then \
		echo "  Pod: $$POD"; \
		kubectl logs -n demo $$POD -c istio-proxy --tail=50; \
	else \
		echo "  âš ï¸  demo namespace ä¸­æ²¡æœ‰æ‰¾åˆ°åº”ç”¨ pod"; \
	fi

# æŸ¥çœ‹æ§åˆ¶å¹³é¢æ—¥å¿—
logs-control:
	@echo "ğŸ“ æŸ¥çœ‹æ§åˆ¶å¹³é¢æ—¥å¿—..."
	@kubectl logs -n boifi -l app=control-plane --tail=50

# è¿è¡Œæ‰€æœ‰ K8s æµ‹è¯•
test-k8s-all:
	@echo "ğŸ§ª è¿è¡Œæ‰€æœ‰ K8s æµ‹è¯•..."
	@bash k8s/tests/run-all-tests.sh
	@echo "âœ… æ‰€æœ‰ K8s æµ‹è¯•å®Œæˆ"

# K8s å¿«é€Ÿé‡æ–°éƒ¨ç½² (å¸è½½ + éƒ¨ç½²)
redeploy: undeploy deploy-all
	@echo "âœ… K8s å¿«é€Ÿé‡æ–°éƒ¨ç½²å®Œæˆ"
