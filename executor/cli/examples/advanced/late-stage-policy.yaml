# ============================================================================
# 延迟阶段故障策略 (带服务选择器)
# ============================================================================
#
# 功能：在请求处理一段时间后再注入故障
# 场景：模拟请求处理中后期的故障（如数据库超时、外部 API 延迟）
#
# 关键字段说明：
#   - selector: 指定策略应用的目标服务和命名空间
#   - start_delay_ms: 请求到达后延迟执行故障的时间（毫秒）
#   - duration_seconds: 策略有效期（秒），0 = 永久有效
#
# 使用方法：
#   hfi-cli policy apply -f advanced/late-stage-policy.yaml
#
# ============================================================================

metadata:
  name: "late-stage-policy"

spec:
  # 服务选择器
  selector:
    service: frontend           # 目标服务名
    namespace: demo             # 目标命名空间

  rules:
    - match:
        method:
          exact: "POST"         # 仅匹配 POST 请求
        path:
          prefix: "/api/"       # 匹配 /api/ 开头的路径
      
      fault:
        percentage: 20          # 20% 概率触发
        
        # 时间控制字段
        start_delay_ms: 500     # 请求到达 500ms 后才执行故障
        duration_seconds: 0     # 永久有效（无自动过期）
        
        # start_delay_ms 使用场景：
        #   0    - 立即执行（请求刚到达）
        #   100  - 模拟快速处理后的故障
        #   500  - 模拟中期处理故障（如验证后）
        #   1000 - 模拟后期处理故障（如数据库操作后）
        #   2000 - 模拟接近超时的故障
        
        delay:
          fixed_delay_ms: 2000  # 额外延迟 2 秒

# ============================================================================
# Late-Stage 故障模拟场景
# ============================================================================
#
# 1. 数据库查询超时：
#    请求处理 → 验证通过 → 数据库查询 → [故障注入] → 超时
#    start_delay_ms: 500
#    delay.fixed_delay: "5s"
#
# 2. 外部 API 调用失败：
#    请求处理 → 本地处理完成 → 调用外部 API → [故障注入] → 503
#    start_delay_ms: 1000
#    abort.httpStatus: 503
#
# 3. 事务提交失败：
#    请求处理 → 业务逻辑完成 → 提交事务 → [故障注入] → 500
#    start_delay_ms: 800
#    abort.httpStatus: 500
#
# 4. 响应序列化慢：
#    请求处理 → 数据准备完成 → 序列化响应 → [故障注入] → 延迟
#    start_delay_ms: 200
#    delay.fixed_delay: "1s"
# ============================================================================
