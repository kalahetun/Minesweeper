# ============================================================================
# 时间限制故障策略 (带服务选择器)
# ============================================================================
#
# 功能：故障立即执行，但在指定时间后自动过期
# 场景：临时故障注入实验，无需手动清理
#
# 关键字段说明：
#   - selector: 指定策略应用的目标服务和命名空间
#   - duration_seconds: 策略有效期（秒），0 = 永久有效
#   - start_delay_ms: 请求到达后延迟执行时间（毫秒），0 = 立即执行
#
# 使用方法：
#   hfi-cli policy apply -f advanced/time-limited-policy.yaml
#
# ============================================================================

metadata:
  name: "time-limited-policy"

spec:
  # 服务选择器
  selector:
    service: frontend           # 目标服务名
    namespace: demo             # 目标命名空间

  rules:
    - match:
        method:
          exact: "GET"
        path:
          prefix: "/api/"       # 匹配所有 /api/ 开头的路径
      
      fault:
        percentage: 50          # 50% 概率触发
        
        # 时间控制字段
        start_delay_ms: 0       # 请求到达时立即执行故障
        duration_seconds: 300   # 策略 5 分钟后自动过期
        
        # duration_seconds 说明：
        #   0    - 永久有效（需要手动删除）
        #   60   - 1 分钟后过期
        #   300  - 5 分钟后过期
        #   3600 - 1 小时后过期
        
        delay:
          fixed_delay_ms: 500

# ============================================================================
# 典型使用场景
# ============================================================================
#
# 1. 快速实验（1 分钟）：
#    duration_seconds: 60
#
# 2. 混沌工程演练（30 分钟）：
#    duration_seconds: 1800
#
# 3. 定时故障注入测试（配合外部调度）：
#    duration_seconds: 600  # 10 分钟窗口
#
# 4. 结合 CLI 覆盖：
#    hfi-cli policy apply -f time-limited-policy.yaml --duration-seconds 120
# ============================================================================
